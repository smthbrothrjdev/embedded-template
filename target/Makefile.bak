BUILD_DIR := ../build/target

# Toolchain
CC      := arm-none-eabi-gcc
OBJCOPY := arm-none-eabi-objcopy
SIZE    := arm-none-eabi-size

# MCU (STM32F411RE = Cortex-M4F)
MCUFLAGS := -mcpu=cortex-m4 -mthumb -mfpu=fpv4-sp-d16 -mfloat-abi=hard

# Common C flags (good for bare-metal)
CFLAGS := -g -O0 -Wall -Wextra -ffreestanding -fdata-sections -ffunction-sections $(MCUFLAGS)

# You will refine these defines later (CubeMX/HAL usually sets a bunch)
CFLAGS += -DSTM32F411xE

# Include paths (adjust to match where you copied CubeMX files)
INCLUDES := \
  -Iinclude \
  -Istm32/cmsis/Include \
  -Istm32/cmsis/Device/ST/STM32F4xx/Include \
  -Istm32/cmsis/Drivers/CMSIS/Device/ST/STM32F4xx/Include
  -Istm32/cmsis/Drivers/CMSIS/Include
# Linker script + link flags
LDSCRIPT := stm32/linker/STM32F411RETx_FLASH.ld
LDFLAGS := -T$(LDSCRIPT) -Wl,-Map=$(BUILD_DIR)/firmware.map -Wl,--gc-sections $(MCUFLAGS)

# Sources:
APP_SRC := $(wildcard src/*.c)
SYS_SRC := stm32/system/system_stm32f4xx.c
STARTUP := stm32/startup/startup_stm32f411xe.s

SRC := $(APP_SRC) $(SYS_SRC)
OBJ := \
  $(patsubst src/%.c,$(BUILD_DIR)/src/%.o,$(APP_SRC)) \
  $(patsubst stm32/system/%.c,$(BUILD_DIR)/stm32/system/%.o,$(SYS_SRC)) \
  $(patsubst stm32/startup/%.s,$(BUILD_DIR)/stm32/startup/%.o,$(STARTUP))

ELF := $(BUILD_DIR)/firmware.elf
BIN := $(BUILD_DIR)/firmware.bin
HEX := $(BUILD_DIR)/firmware.hex

.PHONY: all clean compdb

all: $(ELF) $(BIN) $(HEX)
	@$(SIZE) $(ELF)

# Compile C
$(BUILD_DIR)/src/%.o: src/%.c
	@mkdir -p $(dir $@)
	$(CC) $(CFLAGS) $(INCLUDES) -c -o $@ $<

$(BUILD_DIR)/stm32/system/%.o: stm32/system/%.c
	@mkdir -p $(dir $@)
	$(CC) $(CFLAGS) $(INCLUDES) -c -o $@ $<

# Assemble startup
$(BUILD_DIR)/stm32/startup/%.o: stm32/startup/%.s
	@mkdir -p $(dir $@)
	$(CC) $(CFLAGS) $(INCLUDES) -c -o $@ $<

# Link ELF
$(ELF): $(OBJ)
	@mkdir -p $(BUILD_DIR)
	$(CC) $(OBJ) $(LDFLAGS) -o $@

# Convert to binary formats
$(BIN): $(ELF)
	$(OBJCOPY) -O binary $< $@

$(HEX): $(ELF)
	$(OBJCOPY) -O ihex $< $@

clean:
	rm -rf $(BUILD_DIR)

# Bear compile database (forces rebuild so Bear sees commands)
compdb: clean
	@mkdir -p $(BUILD_DIR)
	@cd .. && bear -- make -C target
	@mv ../compile_commands.json $(BUILD_DIR)/compile_commands.json 2>/dev/null || true

